# load data and libraries
```{r}
library(readxl)
library(dplyr)
library(ggplot2)

cr <- read_xlsx("data/CRB eDNA results.xlsx", sheet = "Roller")
cm <- read_xlsx("data/CRB eDNA results.xlsx", sheet = "Mulch")

# Format roller matrix
roll.matrix <- apply(cr[,2:ncol(cr)], 2, as.numeric)
roll.matrix.hits <- roll.matrix
roll.matrix[roll.matrix>0] <- 1

# Format mulch matrix
mulch.matrix <- apply(cm[,2:ncol(cm)], 2, as.numeric)
mulch.matrix.hits <- mulch.matrix
mulch.matrix[mulch.matrix>0] <- 1

# Format 'trap plus roller eDNA' occupancy model
# traproll.array <- simplify2array(list(trap.matrix, eDNA.matrix))
# traproll.matrix <- apply(visroll.array, c(1,2), max)

# Format multilevel eDNAoccupancy model
# make function to expand "number of hits" into 3 columns of 0/1
make_pcr <- function(x){
  na_df <- data.frame(one = NA, two = NA, three = NA)
  if(is.na(x)){return(na_df)}
  else{
  if(x == 0){return(data.frame(one = 0, two = 0, three = 0))}
  if(x == 1){return(data.frame(one = 1, two = 0, three = 0))}
  if(x == 2){return(data.frame(one = 1, two = 1, three = 0))}
  if(x == 3){return(data.frame(one = 1, two = 1, three = 1))}
  }
}

tlist <- list()
# apply the function to each tree column
for(i in 1:37) {
tlist[[i]] <- sapply(roll.matrix.hits[,i], FUN = make_pcr) %>% t()
}

# create array of PCR detections
y.roll <- array(dim = c(16, 37, 3))
for(i in 1:3){
y.roll[,,i] <- lapply(1:37, FUN = function(x) do.call(c, tlist[[x]][,i])) %>%
  do.call(rbind, .) %>% 
  t()
}

y.roll.mat <- apply(y.roll, c(1,2), max, na.rm = T)
y.roll.mat[is.infinite(y.roll.mat)] <- NA

z.roll = apply(y.roll, 1, max, na.rm = T)
# z.trap = apply(trap.matrix, 1, max, na.rm = T)
# z.both = apply(cbind(z.roll, z.trap), 1, max)

# Create array for the covariate "medium density" (1 or 0) for detection
mdens.roll.mat <- matrix(c(rep(0, 37*7), 
                 rep(0, 37*4),
                 rep(1, 37*3),
                 rep(0, 37*1),
                 rep(0, 37*1)), ncol = 37, byrow = T)
mdens.roll.array <- simplify2array(list(mdens.roll.mat, mdens.roll.mat, mdens.roll.mat))

# Create array for the covariate "high density" (1 or 0) for detection
hdens.roll.mat <- matrix(c(rep(0, 37*7), 
                 rep(0, 37*4),
                 rep(0, 37*3),
                 rep(1, 37*1),
                 rep(0, 37*1)), ncol = 37, byrow = T)
hdens.roll.array <- simplify2array(list(hdens.roll.mat, hdens.roll.mat, hdens.roll.mat))

# Create array for the covariate "high/med density" (1 or 0) for detection
hmdens.roll.array <- mdens.roll.array + hdens.roll.array

# Bundle and summarize data set
jags.data.roll <- list(
  y = y.roll.mat,
  z = ifelse(z.roll > 0, 1, NA),
  n.sites = nrow(y.roll),
  n.trees = ncol(y.roll),
  n.PCRrep = dim(y.roll)[3],
  d = hdens.roll.array+1,
  mdens = mdens.roll.array,
  hdens = hdens.roll.array,
  hmdens = hmdens.roll.array
)


```

# Define visit-level occupancy model in BUGS language
Can apply to either trap, roll, or mulch detection/non-detection data.
```{r}
sink("scripts/crb_occupancy.txt")
cat("
model {

# Priors
mean.psi ~ dunif(0, 1)        # Occupancy intercept on prob. scale
gamma0 <- logit(mean.psi)      #   same on logit scale
# gamma.mdens ~ dnorm(0, 0.1)   # Covariates on logit(occupancy)
gamma.hdens ~ dnorm(0, 0.1)   # Covariates on logit(occupancy)

mean.p ~ dunif(0, 1)          # Detection intercept on prob. scale
alpha0 <- logit(mean.p)       #   same on logit scale
# alpha.mdens ~ dnorm(0, 0.1)   # Covariates on logit(detection)
alpha.hdens ~ dnorm(0, 0.1)   # Covariates on logit(detection)

# Likelihood
for (i in 1:n.sites) {
  z[i] ~ dbern(psi[i])
  logit(psi[i]) <- gamma0 + #gamma.mdens * mdens[i,1,1] +
                   gamma.hdens * hdens[i,1,1]
   for (j in 1:n.trees) {
      y[i,j] ~ dbern(z[i] * p[i,j])
      logit(p[i,j]) <- alpha0 + #alpha.mdens * mdens[i,j,1] +
                       alpha.hdens * hdens[i,j,1]
   }
}

# Derived quantities
# site-level occupancy for different densities
logit(psi.low) <- gamma0
# logit(psi.med) <- gamma0 + gamma.mdens
logit(psi.high) <- gamma0 + gamma.hdens

# detection probability
logit(p.low) <- alpha0
# logit(p.med) <- alpha0 + alpha.mdens
logit(p.high) <- alpha0 + alpha.hdens

# Cumulative board-level detection probability for 1-37 trees/site
for(i in 1:150){
p_tree_n_low[i] <- (1 - (1 - p.low)^i)
# p_tree_n_med[i] <- (1 - (1 - p.med)^i)
p_tree_n_high[i] <- (1 - (1 - p.high)^i)
}

# trees/site required to reach 95% certainty of detecting skinks within occupied areas
n_low <- log(20) / (-log(1 - p.low))
# n_med <- log(20) / (-log(1 - p.med))
n_high <- log(20) / (-log(1 - p.high))

}

",fill=TRUE)
sink()

```
# Run Visual occupany model in JAGS
```{r}
# Initial values
inits <- function() list(int.psi = runif(1), 
                         int.p = runif(1), 
                         gamma.mdens = rnorm(1, 0, 1),
                         alpha.mdens = rnorm(1,0,1),
                         gamma.hdens = rnorm(1, 0, 1),
                         alpha.hdens = rnorm(1,0,1))

# Parameters monitored
params <- c("gamma0", "gamma.mdens", "gamma.hdens",
            "alpha0", "alpha.mdens", "alpha.hdens",
            "psi.low", "psi.med",
            "psi.high", 
            "p.low", "p.med",
            "p.high",
            "p_tree_n_low", "p_tree_n_med", "p_tree_n_high",
            "n_low", "n_med", "n_high")

#####################################
#### Run jags model
#####################################
crb_roll <- jagsUI::jags(data = jags.data.roll,
                         inits = inits,
                         parameters.to.save = params,
                         model.file = "scripts/crb_occupancy.txt",
                         n.chains = 3,
                         n.adapt = NULL,
                         n.burnin = 10000,
                         n.iter = 160000,
                         n.thin = 10,
                         parallel = T,
                         verbose = TRUE,
                         modules = NULL)

# saveRDS(crb_roll, "output/crb_roll_jags_mod_dens_hl.rds")
crb_roll <- readRDS("output/crb_roll_jags_mod_dens_hl.rds")

# Examine model output
crb_roll

# Examine traceplots
# jagsUI::traceplot(crb_roll)

```
# Run "visual + roller eDNA" occupany model in JAGS
note: it's the identical model to the visual model
```{r}
# # Initial values
# inits <- function() list(int.psi = runif(1), 
#                          int.p = runif(1), 
#                          gamma.season = rnorm(1, 0, 1),
#                          alpha.season = rnorm(1,0,1),
#                          gamma.material = rnorm(1, 0, 1),
#                          alpha.material = rnorm(1,0,1))
# 
# # Parameters monitored
# params <- c("gamma0", "gamma.season", "gamma.material",
#             "alpha0", "alpha.season", "alpha.material",
#             "psi.boards.fall.wood", "psi.boards.spring.wood",
#             "psi.boards.fall.metal", "psi.boards.spring.metal",
#             "p.fall.wood", "p.spring.wood",
#             "p.fall.metal", "p.spring.metal",
#             "p_board_n_spring", "p_board_n_fall",
#             "n_spring", "n_fall")
# 
# #####################################
# #### Run jags model
# #####################################
# skink_visroll <- jagsUI::jags(data = skink.jags.data.visroll,
#                          inits = inits,
#                          parameters.to.save = params,
#                          model.file = "scripts/skink_occupancy.txt",
#                          n.chains = 3,
#                          n.adapt = NULL,
#                          n.burnin = 10000,
#                          n.iter = 160000, 
#                          n.thin = 10,
#                          parallel = T,
#                          verbose = TRUE,
#                          modules = NULL)
# 
# # saveRDS(skink_visroll, "output/skink_visroll_jags_mod_material.rds")
# skink_visroll <- readRDS("output/skink_visroll_jags_mod_material.rds")
# 
# # Examine model output
# # skink_visroll
# 
# # Examine traceplots
# # jagsUI::traceplot(skink_visroll)

```
# Graphing detection probability of trap and "trap + roller eDNA"
```{r}


crb_plot = data.frame(posterior = c(crb_roll$sims.list$p.low,
                         crb_roll$sims.list$p.high
                         ),
           Density = c(rep("Low/med. density", 45000), rep("High density", 45000))
           )
            

# summarize posteriors for plotting medians and 95% CI
crb_post_sum = aggregate(
  crb_plot$posterior,
  list(
    crb_plot$Density
  ),
  median
) %>%
  bind_cols(ll = aggregate(
    crb_plot$posterior,
    list(
      crb_plot$Density
    ),
    FUN = 'quantile',
    probs = c(0.025)
  )$x) %>%
  bind_cols(ul = aggregate(
    crb_plot$posterior,
    list(
      crb_plot$Density
    ),
    FUN = 'quantile',
    probs = c(0.975)
  )$x) %>%
  bind_cols(ll10 = aggregate(
    crb_plot$posterior,
    list(
      crb_plot$Density
    ),
    FUN = 'quantile',
    probs = c(0.1)
  )$x) %>%
  bind_cols(ul90 = aggregate(
    crb_plot$posterior,
    list(
      crb_plot$Density
    ),
    FUN = 'quantile',
    probs = c(0.9)
  )$x) %>%
  rename(
    Density = Group.1,
    med = x
  ) 

crb_plot %>%
  ggplot() +
  ggridges::stat_density_ridges(aes(x = posterior, 
                                     y = Density, 
                                     fill = Density),
                                     quantiles = 2,
                                alpha = 0.75, scale = 1.25) +
  geom_errorbar(data= crb_post_sum, aes(xmin = ll, xmax = ul, 
                                          y = c(0.9,1.9),
                             color = Density), width = 0, size = 0.5) +
  geom_errorbar(data= crb_post_sum, aes(xmin = ll10, xmax = ul90, 
                                          y = c(0.9,1.9),
                             color = Density), width = 0, size = 1) +
  geom_point(data= crb_post_sum, aes(x = med, y = c(0.9,1.9),
                             color = Density), size = 3) +  
  scale_fill_manual(values = c("darkblue", "skyblue")) +
  scale_color_manual(values = c("darkblue", "skyblue")) +
  scale_x_continuous(limits = c(0,0.6)) +
  # facet_wrap(~Density) +
  theme_bw() +
  # ggridges::theme_ridges() +
  theme(text = element_text(size = 14),
        axis.text.y = element_text(size = 15),
        strip.text = element_text(size = 14, vjust=0.5), # vjust=0.9 theme_ridges
        strip.background = element_rect(fill = "transparent",
                                        color = NA),
        axis.title.x = element_text(hjust = 0.5),
        panel.background = element_rect(fill = "transparent"),
        plot.background = element_rect(fill = "transparent", color = NA)) +
  labs(x = "Per-sample eDNA detection probability\nat infested site", y = "") +
  coord_cartesian(clip = "off") +
  scale_y_discrete(expand = expand_scale(add = c(.5, 1.5))) +
  guides(fill = "none", color = "none")

 ggsave("figures/crb_roll_detection_probability.jpg",
        dpi = 600, width = 6, height = 4)
```

# Posterior summary statistics for visual-only and visual plus roller eDNA
```{r}
# view point estimates and 95% CI
crb_post_sum

# save table as HTML files
crb_table <- crb_post_sum %>%
  select(1:4) %>%
  mutate(med = med*100,
         ll = ll*100,
         ul = ul*100) %>%
 kableExtra::kbl(caption = "", digits = 1) %>%
  kableExtra::kable_classic(full_width = F, html_font = "Cambria")

crb_table

# save the table to HTML file
kableExtra::save_kable(crb_table,
           "figures/dp_table.html")

%>%
  cat(., file = "figures/dp_table.html")


```


# Plot cumulative detection probability vs. number of board visits
```{r}

# Format data and create figure
# first load the sum_posts function 
sum_posts = function(x, density = NULL){
  sum_posts_list = aggregate(x, by = list(rep("A", nrow(x))), FUN = function(x) quantile(x, c(0.025, 0.10, 0.5, 0.90, 0.975))) %>%
  select(-Group.1) %>%
  c()

sum_posts_df = do.call("rbind", sum_posts_list) %>% 
  as.data.frame() %>%
  rename(q2.5 = 1, q10 = 2, q50 = 3, q90 = 4, q97.5 = 5) %>%
  mutate(n = 1:length(sum_posts_list),
         Density = density)

return(sum_posts_df)
}

cplot_all <- rbind.data.frame(
sum_posts(crb_roll$sims.list$p_tree_n_low, density = "Low/med. density"),
sum_posts(crb_roll$sims.list$p_tree_n_high, density = "High density")
)

cplot_all %>%
  # filter(n < 65) %>%
  ggplot() +
  geom_abline(slope = 0, intercept = 0.95, color = "darkgray", size=1, linetype = 2) +
  geom_ribbon(aes(x = n, ymin = q2.5, ymax = q97.5, fill = Density),
              alpha = 0.5, color = "transparent") +
  # geom_errorbar(aes(x = n, ymin = q2.5, ymax = q97.5, color = Method),
  #             width = 0, size = 0.5) +  
  # geom_errorbar(aes(x = n, ymin = q10, ymax = q90, color = Method),
  #             width = 0, size = 1) +
  scale_fill_manual(values = c("darkgray", "darkgray")) +
  geom_line(aes(x = n, y = q50, color = Density, linetype = Density), size = 1) +
  # geom_point(aes(x = n, y = q50, color = Density, 
  #                shape = Density), size = 2,
  #            fill = "white") +
  scale_shape_manual(values = c(16,21)) +
  scale_color_manual(values = c("black", "black")) +
  # facet_wrap(~season) +
  theme_bw() +
  theme(axis.text = element_text(size = 15),
        axis.title = element_text(size = 15),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 12)) +
  labs(y = "Probability of \u2265 1 detection", 
       x = "Number of trees sampled\nat infested site") +
  theme(strip.text = element_text(
    size = 14,
    colour = "black",
    angle = 0
    ), 
    strip.background = element_rect(fill = "transparent",
                                        color = NA))

# ggsave("figures/crb_cumulative_eDNA_detection.jpg", width = 6, height = 4, dpi = 600)
```

